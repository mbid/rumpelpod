#!/bin/bash
set -e

echo "=== Checking formatting ==="
cargo fmt -- --check

echo ""
echo "=== Building (with tests, no warnings) ==="
RUSTFLAGS="-D warnings" cargo build --all-targets

echo ""
echo "=== Checking for running docker containers ==="
running_containers=$(docker ps -q 2>/dev/null)
if [ -n "$running_containers" ]; then
    echo "ERROR: Found running docker containers. Stop them before running the pipeline:"
    docker ps --format "  {{.ID}}  {{.Image}}  {{.Names}}"
    exit 1
fi
echo "✓ No running docker containers"

echo ""
echo "=== Running tests ==="
cargo xtest

echo ""
echo "=== Running clippy (no warnings) ==="
RUSTFLAGS="-D warnings" cargo clippy --all-targets

echo ""
echo "=== Checking git status ==="
if ! git diff --quiet || ! git diff --cached --quiet || [ -n "$(git ls-files --others --exclude-standard)" ]; then
    echo "⚠️  WARNING: Working directory is not clean!"
    echo ""
    echo "Modified or staged files:"
    git status --short
    echo ""
    echo "Untracked files:"
    git ls-files --others --exclude-standard
else
    echo "✓ Working directory is clean"
fi

echo ""
echo "=== Pipeline complete ==="
